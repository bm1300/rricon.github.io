<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ†è§’çŸ©å½¢å›¾æ ‡ç”Ÿæˆå™¨</title>
    <link rel="icon" type="image/png" href="favicon.png" sizes="32x32">
    <style>
        :root
        {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --border-radius: 8px;
            --layer1-color: #4a6fa5;
            --layer2-color: #e74c3c;
        }

        *
        {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body
        {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container
        {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 30px;
        }

        header
        {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h1
        {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .subtitle
        {
            color: #6c757d;
            font-size: 1.1rem;
        }

        .control-panel
        {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .layer-tabs
        {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .layer-tab
        {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }

            .layer-tab.active
            {
                border-bottom-color: var(--primary-color);
                color: var(--primary-color);
            }

            .layer-tab.layer1.active
            {
                border-bottom-color: var(--layer1-color);
                color: var(--layer1-color);
            }

            .layer-tab.layer2.active
            {
                border-bottom-color: var(--layer2-color);
                color: var(--layer2-color);
            }

        .layer-controls
        {
            display: none;
        }

            .layer-controls.active
            {
                display: block;
            }

        .preview-panel
        {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            grid-column: 3;
            grid-row: 2;
        }

        .section-title
        {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .upload-area
        {
            border: 2px dashed #dee2e6;
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

            .upload-area:hover
            {
                border-color: var(--primary-color);
                background-color: #f8f9fa;
            }

            .upload-area.layer1:hover
            {
                border-color: var(--layer1-color);
            }

            .upload-area.layer2:hover
            {
                border-color: var(--layer2-color);
            }

        .upload-icon
        {
            font-size: 48px;
            color: #adb5bd;
            margin-bottom: 10px;
        }

        .control-group
        {
            margin-bottom: 20px;
        }

        .control-label
        {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

            .control-label span
            {
                font-weight: 500;
            }

        .control-value
        {
            color: var(--primary-color);
            font-weight: 600;
        }

            .control-value.layer1
            {
                color: var(--layer1-color);
            }

            .control-value.layer2
            {
                color: var(--layer2-color);
            }

        input[type="range"]
        {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }

            input[type="range"]::-webkit-slider-thumb
            {
                -webkit-appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: var(--primary-color);
                cursor: pointer;
            }

        input.layer1[type="range"]::-webkit-slider-thumb
        {
            background: var(--layer1-color);
        }

        input.layer2[type="range"]::-webkit-slider-thumb
        {
            background: var(--layer2-color);
        }

        .preview-container
        {
            width: 512px;
            height: 512px;
            position: relative;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-preview
        {
            width: 488px;
            height: 468px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            /* ç²¾ç¡®æ§åˆ¶é˜´å½±èŒƒå›´ï¼Œç¡®ä¿åœ¨512x512å†…å®Œå…¨é€æ˜ */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.8), 0 2px 3px rgba(0, 0, 0, 0.6), 0 4px 4px rgba(0, 0, 0, 0.4), 0 7px 5px rgba(0, 0, 0, 0.2), 0 11px 6px rgba(0, 0, 0, 0.1);
        }

        .acrylic-effect
        {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
            pointer-events: none;
        }

        /* è¾¹ç¼˜åœ†æ¶¦å€’è§’çš„é«˜å…‰æ•ˆæœ */
        .highlight-effect
        {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 20px;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.6), inset 0 -1px 0 rgba(255, 255, 255, 0.5);
            z-index: 3;
            pointer-events: none;
        }

        /* é¡¶éƒ¨é«˜å…‰æ•ˆæœ */
        .top-highlight
        {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40%;
            border-radius: 20px 20px 0 0;
            background: linear-gradient( to bottom, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.15) 60%, rgba(255, 255, 255, 0) 100% );
            z-index: 4;
            pointer-events: none;
        }

        .preview-image
        {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

            .preview-image.layer1
            {
                z-index: 5;
            }

            .preview-image.layer2
            {
                z-index: 6;
            }

        .layer-indicator
        {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
            pointer-events: none;
        }

        .action-buttons
        {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button
        {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .primary-btn
        {
            background: var(--primary-color);
            color: white;
        }

            .primary-btn:hover
            {
                background: var(--secondary-color);
            }

        .secondary-btn
        {
            background: #e9ecef;
            color: var(--dark-color);
        }

            .secondary-btn:hover
            {
                background: #dee2e6;
            }

        .ico-btn
        {
            background: #28a745;
            color: white;
        }

            .ico-btn:hover
            {
                background: #218838;
            }

        .donation-section
        {
            grid-column: 1 / -1;
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .donation-title
        {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .qrcode-container
        {
            width: 200px;
            height: 200px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            border: 1px solid #e9ecef;
        }

        .qrcode-placeholder
        {
            color: #adb5bd;
            text-align: center;
            padding: 20px;
        }

        .donation-text
        {
            color: #6c757d;
            text-align: center;
            max-width: 500px;
            margin-top: 10px;
        }

        .file-size-info
        {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
        }

        .layer-status
        {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
        }

            .layer-status span
            {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 3px;
                margin: 0 3px;
            }

        .layer1-status
        {
            background-color: rgba(74, 111, 165, 0.1);
            color: var(--layer1-color);
        }

        .layer2-status
        {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--layer2-color);
        }

        @media (max-width: 1200px)
        {
            .container
            {
                grid-template-columns: 1fr 1fr;
            }

            .preview-panel
            {
                grid-column: 1 / -1;
                grid-row: 3;
            }
        }

        @media (max-width: 768px)
        {
            .container
            {
                grid-template-columns: 1fr;
            }

            .preview-container
            {
                width: 100%;
                max-width: 512px;
            }
        }

        @media (max-width: 576px)
        {
            .action-buttons
            {
                flex-direction: column;
                width: 100%;
            }

            button
            {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>åœ†è§’çŸ©å½¢å›¾æ ‡ç”Ÿæˆå™¨</h1>
            <p class="subtitle">ä¸€é”®ç”Ÿæˆ512x512é€æ˜PNGå›¾æ ‡å›¾ç‰‡ï¼Œå¹¶å¯ç”ŸæˆICOæ ¼å¼å›¾æ ‡æ–‡ä»¶ã€‚</p>
        </header>
        
        <div class="control-panel layer1-controls">
            <div class="layer-tabs">
                <div class="layer-tab layer1 active" data-layer="1">ç¬¬ä¸€å±‚å›¾ç‰‡</div>
                <div class="layer-tab layer2" data-layer="2">ç¬¬äºŒå±‚å›¾ç‰‡</div>
            </div>
            
            <div class="layer-controls layer1 active" id="layer1Controls">
                <h2 class="section-title" style="color: var(--layer1-color);">ç¬¬ä¸€å±‚å›¾ç‰‡è®¾ç½®</h2>
                
                <div class="upload-area layer1" id="uploadArea1">
                    <div class="upload-icon">ğŸ“</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ç¬¬ä¸€å±‚å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-top: 5px;">æ”¯æŒJPGã€PNGã€GIFç­‰æ ¼å¼</p>
                    <input type="file" id="imageUpload1" accept="image/*" style="display: none;">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>é€æ˜åº¦</span>
                        <span class="control-value layer1" id="opacityValue1">100%</span>
                    </div>
                    <input type="range" class="layer1" id="opacity1" min="0" max="100" value="100">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>å¤§å°</span>
                        <span class="control-value layer1" id="scaleValue1">100%</span>
                    </div>
                    <input type="range" class="layer1" id="scale1" min="10" max="200" value="100">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>æ°´å¹³ä½ç½®</span>
                        <span class="control-value layer1" id="positionXValue1">0</span>
                    </div>
                    <input type="range" class="layer1" id="positionX1" min="-100" max="100" value="0">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>å‚ç›´ä½ç½®</span>
                        <span class="control-value layer1" id="positionYValue1">0</span>
                    </div>
                    <input type="range" class="layer1" id="positionY1" min="-100" max="100" value="0">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>å¯¹æ¯”åº¦</span>
                        <span class="control-value layer1" id="contrastValue1">100%</span>
                    </div>
                    <input type="range" class="layer1" id="contrast1" min="0" max="200" value="100">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>äº®åº¦</span>
                        <span class="control-value layer1" id="brightnessValue1">100%</span>
                    </div>
                    <input type="range" class="layer1" id="brightness1" min="0" max="200" value="100">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>é¥±å’Œåº¦</span>
                        <span class="control-value layer1" id="saturationValue1">100%</span>
                    </div>
                    <input type="range" class="layer1" id="saturation1" min="0" max="200" value="100">
                </div>
                
                <button class="secondary-btn" id="resetLayer1Btn">
                    <span>é‡ç½®ç¬¬ä¸€å±‚è®¾ç½®</span>
                </button>
            </div>
            
            <div class="layer-controls layer2" id="layer2Controls">
                <h2 class="section-title" style="color: var(--layer2-color);">ç¬¬äºŒå±‚å›¾ç‰‡è®¾ç½®</h2>
                
                <div class="upload-area layer2" id="uploadArea2">
                    <div class="upload-icon">ğŸ“</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ç¬¬äºŒå±‚å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-top: 5px;">æ”¯æŒJPGã€PNGã€GIFç­‰æ ¼å¼</p>
                    <input type="file" id="imageUpload2" accept="image/*" style="display: none;">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>é€æ˜åº¦</span>
                        <span class="control-value layer2" id="opacityValue2">100%</span>
                    </div>
                    <input type="range" class="layer2" id="opacity2" min="0" max="100" value="100">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>å¤§å°</span>
                        <span class="control-value layer2" id="scaleValue2">100%</span>
                    </div>
                    <input type="range" class="layer2" id="scale2" min="10" max="200" value="100">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>æ°´å¹³ä½ç½®</span>
                        <span class="control-value layer2" id="positionXValue2">0</span>
                    </div>
                    <input type="range" class="layer2" id="positionX2" min="-100" max="100" value="0">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>å‚ç›´ä½ç½®</span>
                        <span class="control-value layer2" id="positionYValue2">0</span>
                    </div>
                    <input type="range" class="layer2" id="positionY2" min="-100" max="100" value="0">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>å¯¹æ¯”åº¦</span>
                        <span class="control-value layer2" id="contrastValue2">100%</span>
                    </div>
                    <input type="range" class="layer2" id="contrast2" min="0" max="200" value="100">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>äº®åº¦</span>
                        <span class="control-value layer2" id="brightnessValue2">100%</span>
                    </div>
                    <input type="range" class="layer2" id="brightness2" min="0" max="200" value="100">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>é¥±å’Œåº¦</span>
                        <span class="control-value layer2" id="saturationValue2">100%</span>
                    </div>
                    <input type="range" class="layer2" id="saturation2" min="0" max="200" value="100">
                </div>
                
                <button class="secondary-btn" id="resetLayer2Btn">
                    <span>é‡ç½®ç¬¬äºŒå±‚è®¾ç½®</span>
                </button>
            </div>
        </div>
        
        <div class="control-panel">
            <h2 class="section-title">å…¨å±€è®¾ç½®</h2>
            
            <div class="control-group">
                <div class="control-label">
                    <span>å›¾å±‚é¡ºåº</span>
                    <span class="control-value" id="layerOrderValue">ç¬¬ä¸€å±‚åœ¨ä¸‹ï¼Œç¬¬äºŒå±‚åœ¨ä¸Š</span>
                </div>
                <select id="layerOrder" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #dee2e6;">
                    <option value="layer1-bottom">ç¬¬ä¸€å±‚åœ¨ä¸‹ï¼Œç¬¬äºŒå±‚åœ¨ä¸Š</option>
                    <option value="layer2-bottom">ç¬¬äºŒå±‚åœ¨ä¸‹ï¼Œç¬¬ä¸€å±‚åœ¨ä¸Š</option>
                </select>
            </div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>åœ†è§’åŠå¾„</span>
                    <span class="control-value" id="radiusValue">30px</span>
                </div>
                <input type="range" id="radius" min="0" max="100" value="30">
            </div>
            
            <button class="secondary-btn" id="resetAllBtn" style="width: 100%; margin-top: 20px;">
                <span>é‡ç½®æ‰€æœ‰è®¾ç½®</span>
            </button>
        </div>
        
        <div class="preview-panel">
            <h2 class="section-title">å›¾æ ‡é¢„è§ˆ</h2>
            
            <div class="preview-container">
                <div class="icon-preview">
                    <div class="layer-indicator">ç¬¬ä¸€å±‚åœ¨ä¸‹ï¼Œç¬¬äºŒå±‚åœ¨ä¸Š</div>
                    <img id="previewImage1" class="preview-image layer1" src="" alt="ç¬¬ä¸€å±‚é¢„è§ˆ" style="display: none;">
                    <img id="previewImage2" class="preview-image layer2" src="" alt="ç¬¬äºŒå±‚é¢„è§ˆ" style="display: none;">
                    <div class="acrylic-effect"></div>
                    <div class="highlight-effect"></div>
                    <div class="top-highlight"></div>
                </div>
            </div>
            
            <div class="layer-status">
                <span class="layer1-status">ç¬¬ä¸€å±‚: <span id="layer1Status">æœªä¸Šä¼ </span></span>
                <span class="layer2-status">ç¬¬äºŒå±‚: <span id="layer2Status">æœªä¸Šä¼ </span></span>
            </div>
            
            <div class="action-buttons">
                <button class="secondary-btn" id="resetPreviewBtn">
                    <span>é‡ç½®é¢„è§ˆè®¾ç½®</span>
                </button>
                <button class="primary-btn" id="downloadPngBtn">
                    <span>ä¸‹è½½PNGå›¾æ ‡</span>
                </button>
                <button class="ico-btn" id="downloadIcoBtn">
                    <span>ä¸‹è½½ICOå›¾æ ‡</span>
                </button>
            </div>
            <p class="file-size-info">PNG: 512x512 é€æ˜èƒŒæ™¯ | ICO: 512x512 å•å°ºå¯¸</p>
        </div>
        
        <div class="donation-section">
            <h2 class="donation-title">æ”¯æŒå¼€å‘è€…</h2>
            <div class="qrcode-container">
                <div class="qrcode-placeholder">
                    <img src="æ‰“èµäºŒç»´ç -200x200.jpg" alt="æ‰“èµäºŒç»´ç " style="width: 200px; height: 200px; object-fit: cover;">
                </div>
            </div>
            <p class="donation-text">å¦‚æœè¿™ä¸ªå·¥å…·å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œä¸å¦¨æ‰“èµæ”¯æŒæˆ‘ç»§ç»­æ”¹è¿›å’Œåˆ›å»ºæ›´å¤šæ²¡å•¥ç”¨çš„å†·å·¥å…·(âÂ´â—¡`â)ã€‚</p>
            <p class="donation-text">BM1300 | 249390193@qq.com</p>
        </div>
    </div>

    <script>
        // ICOæ–‡ä»¶ç”Ÿæˆå™¨
        class IcoGenerator {
            constructor() {
                this.HEADER_SIZE = 6;
                this.DIRECTORY_SIZE = 16;
                this.HEADER_AND_DIRECTORY_SIZE = this.HEADER_SIZE + this.DIRECTORY_SIZE;
            }
            
            // å°†16ä½æ•´æ•°å†™å…¥ç¼“å†²åŒº
            writeUint16(buffer, value, offset) {
                buffer[offset] = value & 0xFF;
                buffer[offset + 1] = (value >> 8) & 0xFF;
                return offset + 2;
            }
            
            // å°†32ä½æ•´æ•°å†™å…¥ç¼“å†²åŒº
            writeUint32(buffer, value, offset) {
                buffer[offset] = value & 0xFF;
                buffer[offset + 1] = (value >> 8) & 0xFF;
                buffer[offset + 2] = (value >> 16) & 0xFF;
                buffer[offset + 3] = (value >> 24) & 0xFF;
                return offset + 4;
            }
            
            // å°†PNGæ•°æ®è½¬æ¢ä¸ºICOæ–‡ä»¶
            async pngToIco(pngDataUrl) {
                return new Promise((resolve, reject) => {
                    // å°†dataURLè½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®
                    const binaryString = atob(pngDataUrl.split(',')[1]);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    // åˆ›å»ºICOæ–‡ä»¶ç¼“å†²åŒº
                    // æ€»å¤§å° = æ–‡ä»¶å¤´ + ç›®å½•é¡¹ + PNGæ•°æ®
                    const totalSize = this.HEADER_AND_DIRECTORY_SIZE + bytes.length;
                    const icoBuffer = new Uint8Array(totalSize);
                    
                    let offset = 0;
                    
                    // å†™å…¥ICOæ–‡ä»¶å¤´
                    // ä¿ç•™å­— (0)
                    offset = this.writeUint16(icoBuffer, 0, offset);
                    // ç±»å‹ (1=ICO, 2=CUR)
                    offset = this.writeUint16(icoBuffer, 1, offset);
                    // å›¾åƒæ•°é‡ (1)
                    offset = this.writeUint16(icoBuffer, 1, offset);
                    
                    // å†™å…¥ç›®å½•é¡¹
                    // å®½åº¦ (0è¡¨ç¤º256åƒç´ ï¼Œå› ä¸º512>255ï¼Œæ‰€ä»¥ç”¨0è¡¨ç¤º)
                    icoBuffer[offset++] = 0;
                    // é«˜åº¦ (0è¡¨ç¤º256åƒç´ )
                    icoBuffer[offset++] = 0;
                    // è°ƒè‰²æ¿é¢œè‰²æ•° (0è¡¨ç¤ºæ²¡æœ‰è°ƒè‰²æ¿)
                    icoBuffer[offset++] = 0;
                    // ä¿ç•™ (0)
                    icoBuffer[offset++] = 0;
                    // é¢œè‰²å¹³é¢ (0æˆ–1)
                    offset = this.writeUint16(icoBuffer, 0, offset);
                    // æ¯åƒç´ ä½æ•° (PNGæ ¼å¼ï¼Œè®¾ç½®ä¸º32)
                    offset = this.writeUint16(icoBuffer, 32, offset);
                    // å›¾åƒæ•°æ®å¤§å° (PNGæ•°æ®å¤§å°)
                    offset = this.writeUint32(icoBuffer, bytes.length, offset);
                    // å›¾åƒæ•°æ®åç§»é‡ (ä»æ–‡ä»¶å¼€å§‹åˆ°å›¾åƒæ•°æ®çš„åç§»)
                    offset = this.writeUint32(icoBuffer, this.HEADER_AND_DIRECTORY_SIZE, offset);
                    
                    // å†™å…¥PNGæ•°æ®
                    icoBuffer.set(bytes, this.HEADER_AND_DIRECTORY_SIZE);
                    
                    resolve(icoBuffer);
                });
            }
            
            // åˆ›å»ºICO Blobå¹¶ä¸‹è½½
            async downloadIco(pngDataUrl, filename = 'icon.ico') {
                try {
                    const icoBuffer = await this.pngToIco(pngDataUrl);
                    const blob = new Blob([icoBuffer], { type: 'image/x-icon' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('ç”ŸæˆICOæ–‡ä»¶å¤±è´¥:', error);
                    throw error;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ICOç”Ÿæˆå™¨
            const icoGenerator = new IcoGenerator();
            
            // è·å–DOMå…ƒç´  - å›¾å±‚åˆ‡æ¢
            const layerTabs = document.querySelectorAll('.layer-tab');
            const layer1Controls = document.getElementById('layer1Controls');
            const layer2Controls = document.getElementById('layer2Controls');
            
            // è·å–DOMå…ƒç´  - ç¬¬ä¸€å±‚
            const uploadArea1 = document.getElementById('uploadArea1');
            const imageUpload1 = document.getElementById('imageUpload1');
            const previewImage1 = document.getElementById('previewImage1');
            
            // è·å–DOMå…ƒç´  - ç¬¬äºŒå±‚
            const uploadArea2 = document.getElementById('uploadArea2');
            const imageUpload2 = document.getElementById('imageUpload2');
            const previewImage2 = document.getElementById('previewImage2');
            
            // è·å–DOMå…ƒç´  - ç¬¬ä¸€å±‚æ§åˆ¶
            const opacitySlider1 = document.getElementById('opacity1');
            const scaleSlider1 = document.getElementById('scale1');
            const positionXSlider1 = document.getElementById('positionX1');
            const positionYSlider1 = document.getElementById('positionY1');
            const contrastSlider1 = document.getElementById('contrast1');
            const brightnessSlider1 = document.getElementById('brightness1');
            const saturationSlider1 = document.getElementById('saturation1');
            
            // è·å–DOMå…ƒç´  - ç¬¬äºŒå±‚æ§åˆ¶
            const opacitySlider2 = document.getElementById('opacity2');
            const scaleSlider2 = document.getElementById('scale2');
            const positionXSlider2 = document.getElementById('positionX2');
            const positionYSlider2 = document.getElementById('positionY2');
            const contrastSlider2 = document.getElementById('contrast2');
            const brightnessSlider2 = document.getElementById('brightness2');
            const saturationSlider2 = document.getElementById('saturation2');
            
            // è·å–DOMå…ƒç´  - å…¨å±€æ§åˆ¶
            const layerOrderSelect = document.getElementById('layerOrder');
            const radiusSlider = document.getElementById('radius');
            
            // è·å–DOMå…ƒç´  - æŒ‰é’®
            const resetLayer1Btn = document.getElementById('resetLayer1Btn');
            const resetLayer2Btn = document.getElementById('resetLayer2Btn');
            const resetAllBtn = document.getElementById('resetAllBtn');
            const resetPreviewBtn = document.getElementById('resetPreviewBtn');
            const downloadPngBtn = document.getElementById('downloadPngBtn');
            const downloadIcoBtn = document.getElementById('downloadIcoBtn');
            
            // æ˜¾ç¤ºå€¼çš„å…ƒç´ 
            const opacityValue1 = document.getElementById('opacityValue1');
            const scaleValue1 = document.getElementById('scaleValue1');
            const positionXValue1 = document.getElementById('positionXValue1');
            const positionYValue1 = document.getElementById('positionYValue1');
            const contrastValue1 = document.getElementById('contrastValue1');
            const brightnessValue1 = document.getElementById('brightnessValue1');
            const saturationValue1 = document.getElementById('saturationValue1');
            
            const opacityValue2 = document.getElementById('opacityValue2');
            const scaleValue2 = document.getElementById('scaleValue2');
            const positionXValue2 = document.getElementById('positionXValue2');
            const positionYValue2 = document.getElementById('positionYValue2');
            const contrastValue2 = document.getElementById('contrastValue2');
            const brightnessValue2 = document.getElementById('brightnessValue2');
            const saturationValue2 = document.getElementById('saturationValue2');
            
            const layerOrderValue = document.getElementById('layerOrderValue');
            const radiusValue = document.getElementById('radiusValue');
            
            // å›¾å±‚çŠ¶æ€
            const layer1Status = document.getElementById('layer1Status');
            const layer2Status = document.getElementById('layer2Status');
            const layerIndicator = document.querySelector('.layer-indicator');
            
            // å½“å‰å›¾ç‰‡çŠ¶æ€
            let currentImage1 = null;
            let originalWidth1 = 0;
            let originalHeight1 = 0;
            
            let currentImage2 = null;
            let originalWidth2 = 0;
            let originalHeight2 = 0;
            
            let currentImageDataUrl = null;
            
            // å›¾å±‚åˆ‡æ¢åŠŸèƒ½
            layerTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const layer = this.getAttribute('data-layer');
                    
                    // æ›´æ–°æ´»åŠ¨æ ‡ç­¾
                    layerTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”çš„æ§åˆ¶é¢æ¿
                    if (layer === '1') {
                        layer1Controls.classList.add('active');
                        layer2Controls.classList.remove('active');
                    } else {
                        layer1Controls.classList.remove('active');
                        layer2Controls.classList.add('active');
                    }
                });
            });
            
            // ç¬¬ä¸€å±‚ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            uploadArea1.addEventListener('click', function() {
                imageUpload1.click();
            });
            
            // ç¬¬äºŒå±‚ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            uploadArea2.addEventListener('click', function() {
                imageUpload2.click();
            });
            
            // ç¬¬ä¸€å±‚æ‹–æ”¾åŠŸèƒ½
            uploadArea1.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea1.style.borderColor = 'var(--layer1-color)';
                uploadArea1.style.backgroundColor = '#f0f4f8';
            });
            
            uploadArea1.addEventListener('dragleave', function() {
                uploadArea1.style.borderColor = '#dee2e6';
                uploadArea1.style.backgroundColor = '';
            });
            
            uploadArea1.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea1.style.borderColor = '#dee2e6';
                uploadArea1.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0], 1);
                }
            });
            
            // ç¬¬äºŒå±‚æ‹–æ”¾åŠŸèƒ½
            uploadArea2.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea2.style.borderColor = 'var(--layer2-color)';
                uploadArea2.style.backgroundColor = '#f0f4f8';
            });
            
            uploadArea2.addEventListener('dragleave', function() {
                uploadArea2.style.borderColor = '#dee2e6';
                uploadArea2.style.backgroundColor = '';
            });
            
            uploadArea2.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea2.style.borderColor = '#dee2e6';
                uploadArea2.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0], 2);
                }
            });
            
            // ç¬¬ä¸€å±‚æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            imageUpload1.addEventListener('change', function(e) {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0], 1);
                }
            });
            
            // ç¬¬äºŒå±‚æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            imageUpload2.addEventListener('change', function(e) {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0], 2);
                }
            });
            
            // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            function handleImageUpload(file, layer) {
                if (!file.type.match('image.*')) {
                    alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (layer === 1) {
                        previewImage1.src = e.target.result;
                        previewImage1.style.display = 'block';
                        
                        // å›¾ç‰‡åŠ è½½åè·å–åŸå§‹å°ºå¯¸
                        previewImage1.onload = function() {
                            currentImage1 = previewImage1;
                            originalWidth1 = previewImage1.naturalWidth;
                            originalHeight1 = previewImage1.naturalHeight;
                            
                            layer1Status.textContent = 'å·²ä¸Šä¼ ';
                            applyAdjustments();
                        };
                    } else {
                        previewImage2.src = e.target.result;
                        previewImage2.style.display = 'block';
                        
                        // å›¾ç‰‡åŠ è½½åè·å–åŸå§‹å°ºå¯¸
                        previewImage2.onload = function() {
                            currentImage2 = previewImage2;
                            originalWidth2 = previewImage2.naturalWidth;
                            originalHeight2 = previewImage2.naturalHeight;
                            
                            layer2Status.textContent = 'å·²ä¸Šä¼ ';
                            applyAdjustments();
                        };
                    }
                };
                reader.readAsDataURL(file);
            }
            
            // æ›´æ–°æ»‘å—å€¼æ˜¾ç¤º
            function updateSliderValues() {
                // ç¬¬ä¸€å±‚
                opacityValue1.textContent = opacitySlider1.value + '%';
                scaleValue1.textContent = scaleSlider1.value + '%';
                positionXValue1.textContent = positionXSlider1.value;
                positionYValue1.textContent = positionYSlider1.value;
                contrastValue1.textContent = contrastSlider1.value + '%';
                brightnessValue1.textContent = brightnessSlider1.value + '%';
                saturationValue1.textContent = saturationSlider1.value + '%';
                
                // ç¬¬äºŒå±‚
                opacityValue2.textContent = opacitySlider2.value + '%';
                scaleValue2.textContent = scaleSlider2.value + '%';
                positionXValue2.textContent = positionXSlider2.value;
                positionYValue2.textContent = positionYSlider2.value;
                contrastValue2.textContent = contrastSlider2.value + '%';
                brightnessValue2.textContent = brightnessSlider2.value + '%';
                saturationValue2.textContent = saturationSlider2.value + '%';
                
                // å…¨å±€
                layerOrderValue.textContent = layerOrderSelect.options[layerOrderSelect.selectedIndex].text;
                radiusValue.textContent = radiusSlider.value + 'px';
            }
            
            // é‡ç½®ç¬¬ä¸€å±‚è°ƒæ•´
            function resetLayer1Adjustments() {
                opacitySlider1.value = 100;
                scaleSlider1.value = 100;
                positionXSlider1.value = 0;
                positionYSlider1.value = 0;
                contrastSlider1.value = 100;
                brightnessSlider1.value = 100;
                saturationSlider1.value = 100;
                
                updateSliderValues();
                applyAdjustments();
            }
            
            // é‡ç½®ç¬¬äºŒå±‚è°ƒæ•´
            function resetLayer2Adjustments() {
                opacitySlider2.value = 100;
                scaleSlider2.value = 100;
                positionXSlider2.value = 0;
                positionYSlider2.value = 0;
                contrastSlider2.value = 100;
                brightnessSlider2.value = 100;
                saturationSlider2.value = 100;
                
                updateSliderValues();
                applyAdjustments();
            }
            
            // é‡ç½®æ‰€æœ‰è°ƒæ•´
            function resetAllAdjustments() {
                resetLayer1Adjustments();
                resetLayer2Adjustments();
                
                layerOrderSelect.value = 'layer1-bottom';
                radiusSlider.value = 20;
                
                updateSliderValues();
                applyAdjustments();
            }
            
            // åº”ç”¨æ‰€æœ‰è°ƒæ•´åˆ°å›¾ç‰‡
            function applyAdjustments() {
                // æ›´æ–°å›¾å±‚é¡ºåºæŒ‡ç¤ºå™¨
                const layerOrder = layerOrderSelect.value;
                if (layerOrder === 'layer1-bottom') {
                    layerIndicator.textContent = 'ç¬¬ä¸€å±‚åœ¨ä¸‹ï¼Œç¬¬äºŒå±‚åœ¨ä¸Š';
                    previewImage1.style.zIndex = 5;
                    previewImage2.style.zIndex = 6;
                } else {
                    layerIndicator.textContent = 'ç¬¬äºŒå±‚åœ¨ä¸‹ï¼Œç¬¬ä¸€å±‚åœ¨ä¸Š';
                    previewImage1.style.zIndex = 6;
                    previewImage2.style.zIndex = 5;
                }
                
                // æ›´æ–°åœ†è§’åŠå¾„
                const radius = radiusSlider.value;
                document.querySelector('.icon-preview').style.borderRadius = radius + 'px';
                document.querySelector('.highlight-effect').style.borderRadius = radius + 'px';
                document.querySelector('.top-highlight').style.borderRadius = radius + 'px  ' + radius + 'px 0 0';
                
                // åº”ç”¨ç¬¬ä¸€å±‚è°ƒæ•´
                if (currentImage1) {
                    const scale1 = scaleSlider1.value / 100;
                    const posX1 = positionXSlider1.value;
                    const posY1 = positionYSlider1.value;
                    const contrast1 = contrastSlider1.value;
                    const brightness1 = brightnessSlider1.value;
                    const saturation1 = saturationSlider1.value;
                    const opacity1 = opacitySlider1.value / 100;
                    
                    // åº”ç”¨CSSæ»¤é•œå’Œé€æ˜åº¦
                    previewImage1.style.filter = `
                        contrast(${contrast1}%) 
                        brightness(${brightness1}%) 
                        saturate(${saturation1}%)
                    `;
                    previewImage1.style.opacity = opacity1;
                    
                    // è®¡ç®—ç¼©æ”¾åçš„å°ºå¯¸
                    const containerWidth = 488;
                    const containerHeight = 468;
                    
                    // è®¡ç®—æœ€å°ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿çŸ­è¾¹ç­‰äºå®¹å™¨çŸ­è¾¹
                    const minScale1 = Math.min(
                        containerWidth / originalWidth1,
                        containerHeight / originalHeight1
                    );
                    
                    // å®é™…ç¼©æ”¾æ¯”ä¾‹
                    const actualScale1 = minScale1 * scale1;
                    
                    // è®¡ç®—ç¼©æ”¾åçš„å°ºå¯¸
                    const scaledWidth1 = originalWidth1 * actualScale1;
                    const scaledHeight1 = originalHeight1 * actualScale1;
                    
                    // åº”ç”¨ç¼©æ”¾å’Œä½ç½®
                    previewImage1.style.width = `${scaledWidth1}px`;
                    previewImage1.style.height = `${scaledHeight1}px`;
                    
                    // è®¡ç®—ä½ç½®åç§»
                    const offsetX1 = (containerWidth - scaledWidth1) / 2 + (posX1 * containerWidth / 100);
                    const offsetY1 = (containerHeight - scaledHeight1) / 2 + (posY1 * containerHeight / 100);
                    
                    previewImage1.style.transform = `translate(${offsetX1}px, ${offsetY1}px)`;
                }
                
                // åº”ç”¨ç¬¬äºŒå±‚è°ƒæ•´
                if (currentImage2) {
                    const scale2 = scaleSlider2.value / 100;
                    const posX2 = positionXSlider2.value;
                    const posY2 = positionYSlider2.value;
                    const contrast2 = contrastSlider2.value;
                    const brightness2 = brightnessSlider2.value;
                    const saturation2 = saturationSlider2.value;
                    const opacity2 = opacitySlider2.value / 100;
                    
                    // åº”ç”¨CSSæ»¤é•œå’Œé€æ˜åº¦
                    previewImage2.style.filter = `
                        contrast(${contrast2}%) 
                        brightness(${brightness2}%) 
                        saturate(${saturation2}%)
                    `;
                    previewImage2.style.opacity = opacity2;
                    
                    // è®¡ç®—ç¼©æ”¾åçš„å°ºå¯¸
                    const containerWidth = 488;
                    const containerHeight = 468;
                    
                    // è®¡ç®—æœ€å°ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿çŸ­è¾¹ç­‰äºå®¹å™¨çŸ­è¾¹
                    const minScale2 = Math.min(
                        containerWidth / originalWidth2,
                        containerHeight / originalHeight2
                    );
                    
                    // å®é™…ç¼©æ”¾æ¯”ä¾‹
                    const actualScale2 = minScale2 * scale2;
                    
                    // è®¡ç®—ç¼©æ”¾åçš„å°ºå¯¸
                    const scaledWidth2 = originalWidth2 * actualScale2;
                    const scaledHeight2 = originalHeight2 * actualScale2;
                    
                    // åº”ç”¨ç¼©æ”¾å’Œä½ç½®
                    previewImage2.style.width = `${scaledWidth2}px`;
                    previewImage2.style.height = `${scaledHeight2}px`;
                    
                    // è®¡ç®—ä½ç½®åç§»
                    const offsetX2 = (containerWidth - scaledWidth2) / 2 + (posX2 * containerWidth / 100);
                    const offsetY2 = (containerHeight - scaledHeight2) / 2 + (posY2 * containerHeight / 100);
                    
                    previewImage2.style.transform = `translate(${offsetX2}px, ${offsetY2}px)`;
                }
                
                // æ¸…é™¤ç¼“å­˜çš„å›¾åƒæ•°æ®
                currentImageDataUrl = null;
            }
            
            // ä¸ºæ‰€æœ‰æ»‘å—å’Œé€‰æ‹©æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            const layer1Sliders = [
                opacitySlider1, scaleSlider1, positionXSlider1, positionYSlider1, 
                contrastSlider1, brightnessSlider1, saturationSlider1
            ];
            
            const layer2Sliders = [
                opacitySlider2, scaleSlider2, positionXSlider2, positionYSlider2, 
                contrastSlider2, brightnessSlider2, saturationSlider2
            ];
            
            const globalControls = [layerOrderSelect, radiusSlider];
            
            layer1Sliders.forEach(slider => {
                slider.addEventListener('input', function() {
                    updateSliderValues();
                    applyAdjustments();
                });
            });
            
            layer2Sliders.forEach(slider => {
                slider.addEventListener('input', function() {
                    updateSliderValues();
                    applyAdjustments();
                });
            });
            
            globalControls.forEach(control => {
                control.addEventListener('input', function() {
                    updateSliderValues();
                    applyAdjustments();
                });
            });
            
            // æŒ‰é’®äº‹ä»¶
            resetLayer1Btn.addEventListener('click', resetLayer1Adjustments);
            resetLayer2Btn.addEventListener('click', resetLayer2Adjustments);
            resetAllBtn.addEventListener('click', resetAllAdjustments);
            resetPreviewBtn.addEventListener('click', function() {
                resetAllAdjustments();
            });
            
            // ç”Ÿæˆå›¾æ ‡ç”»å¸ƒ
            function generateIconCanvas() {
                // åˆ›å»ºCanvasç”¨äºç”Ÿæˆå›¾æ ‡
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 512;
                const ctx = canvas.getContext('2d');
                
                // æ¸…é™¤ç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // å›¾æ ‡ä½ç½®å’Œå°ºå¯¸
                const rectX = (512 - 488) / 2;
                const rectY = (512 - 468) / 2;
                const radius = parseInt(radiusSlider.value);
                
                // åˆ›å»ºåœ†è§’çŸ©å½¢è·¯å¾„
                function createRoundedRectPath(x, y, width, height, radius) {
                    ctx.beginPath();
                    ctx.moveTo(x + radius, y);
                    ctx.lineTo(x + width - radius, y);
                    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                    ctx.lineTo(x + width, y + height - radius);
                    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                    ctx.lineTo(x + radius, y + height);
                    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                    ctx.lineTo(x, y + radius);
                    ctx.quadraticCurveTo(x, y, x + radius, y);
                    ctx.closePath();
                }
                
                // ç»˜åˆ¶é˜´å½± - ç²¾ç¡®æ§åˆ¶é˜´å½±èŒƒå›´ï¼Œä»100%ä¸é€æ˜åº¦å¼€å§‹ï¼Œå¿«é€Ÿè¡°å‡
                const shadowLayers = [
                    { blur: 2, offsetY: 1, opacity: 0.8 },
                    { blur: 3, offsetY: 2, opacity: 0.6 },
                    { blur: 4, offsetY: 4, opacity: 0.4 },
                    { blur: 5, offsetY: 7, opacity: 0.2 },
                    { blur: 6, offsetY: 11, opacity: 0.1 }
                ];
                
                shadowLayers.forEach(layer => {
                    ctx.save();
                    ctx.shadowColor = `rgba(0, 0, 0, ${layer.opacity})`;
                    ctx.shadowBlur = layer.blur;
                    ctx.shadowOffsetY = layer.offsetY;
                    
                    createRoundedRectPath(rectX, rectY, 488, 468, radius);
                    ctx.fillStyle = 'rgba(0, 0, 0, 1)'; // ä½¿ç”¨çº¯é»‘è‰²ä½œä¸ºé˜´å½±æº
                    ctx.fill();
                    ctx.restore();
                });
                
                // ç»˜åˆ¶åœ†è§’çŸ©å½¢èƒŒæ™¯ï¼ˆäºšå…‹åŠ›æ•ˆæœï¼‰
                createRoundedRectPath(rectX, rectY, 488, 468, radius);
                
                // å¡«å……åŠé€æ˜ç™½è‰²ï¼ˆäºšå…‹åŠ›æ•ˆæœï¼‰
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.fill();
                
                // è£å‰ªåˆ°åœ†è§’çŸ©å½¢
                ctx.save();
                ctx.clip();
                
                // è·å–å›¾å±‚é¡ºåº
                const layerOrder = layerOrderSelect.value;
                
                // ç¡®å®šç»˜åˆ¶é¡ºåº
                let firstLayer, secondLayer;
                if (layerOrder === 'layer1-bottom') {
                    firstLayer = { image: currentImage1, isLayer1: true };
                    secondLayer = { image: currentImage2, isLayer1: false };
                } else {
                    firstLayer = { image: currentImage2, isLayer1: false };
                    secondLayer = { image: currentImage1, isLayer1: true };
                }
                
                // ç»˜åˆ¶ç¬¬ä¸€å±‚
                if (firstLayer.image) {
                    drawLayerToCanvas(ctx, firstLayer.image, firstLayer.isLayer1, rectX, rectY);
                }
                
                // ç»˜åˆ¶ç¬¬äºŒå±‚
                if (secondLayer.image) {
                    drawLayerToCanvas(ctx, secondLayer.image, secondLayer.isLayer1, rectX, rectY);
                }
                
                // æ¢å¤è£å‰ªçŠ¶æ€
                ctx.restore();
                
                // æ·»åŠ é«˜å…‰æ•ˆæœ
                createRoundedRectPath(rectX, rectY, 488, 468, radius);
                
                // æ·»åŠ è¾¹ç¼˜é«˜å…‰
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // æ·»åŠ é¡¶éƒ¨é«˜å…‰
                const gradient = ctx.createLinearGradient(rectX, rectY, rectX, rectY + 180);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
                gradient.addColorStop(0.6, 'rgba(255, 255, 255, 0.15)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                ctx.fillStyle = gradient;
                ctx.fill();
                
                return canvas;
            }
            
            // ç»˜åˆ¶å›¾å±‚åˆ°ç”»å¸ƒ
            function drawLayerToCanvas(ctx, image, isLayer1, rectX, rectY) {
                // è·å–å¯¹åº”å›¾å±‚çš„å‚æ•°
                let scale, posX, posY, contrast, brightness, saturation, opacity;
                let originalWidth, originalHeight;
                
                if (isLayer1) {
                    scale = scaleSlider1.value / 100;
                    posX = positionXSlider1.value;
                    posY = positionYSlider1.value;
                    contrast = contrastSlider1.value;
                    brightness = brightnessSlider1.value;
                    saturation = saturationSlider1.value;
                    opacity = opacitySlider1.value / 100;
                    originalWidth = originalWidth1;
                    originalHeight = originalHeight1;
                } else {
                    scale = scaleSlider2.value / 100;
                    posX = positionXSlider2.value;
                    posY = positionYSlider2.value;
                    contrast = contrastSlider2.value;
                    brightness = brightnessSlider2.value;
                    saturation = saturationSlider2.value;
                    opacity = opacitySlider2.value / 100;
                    originalWidth = originalWidth2;
                    originalHeight = originalHeight2;
                }
                
                // è®¾ç½®å…¨å±€é€æ˜åº¦
                ctx.globalAlpha = opacity;
                
                // åº”ç”¨æ»¤é•œ
                ctx.filter = `contrast(${contrast}%) brightness(${brightness}%) saturate(${saturation}%)`;
                
                // è®¡ç®—ç¼©æ”¾åçš„å°ºå¯¸
                const containerWidth = 488;
                const containerHeight = 468;
                
                // è®¡ç®—æœ€å°ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿çŸ­è¾¹ç­‰äºå®¹å™¨çŸ­è¾¹
                const minScale = Math.min(
                    containerWidth / originalWidth,
                    containerHeight / originalHeight
                );
                
                // å®é™…ç¼©æ”¾æ¯”ä¾‹
                const actualScale = minScale * scale;
                
                // è®¡ç®—ç¼©æ”¾åçš„å°ºå¯¸
                const scaledWidth = originalWidth * actualScale;
                const scaledHeight = originalHeight * actualScale;
                
                // è®¡ç®—ä½ç½®åç§»
                const offsetX = (containerWidth - scaledWidth) / 2 + (posX * containerWidth / 100);
                const offsetY = (containerHeight - scaledHeight) / 2 + (posY * containerHeight / 100);
                
                // ç»˜åˆ¶å›¾ç‰‡
                ctx.drawImage(
                    image, 
                    rectX + offsetX, 
                    rectY + offsetY, 
                    scaledWidth, 
                    scaledHeight
                );
                
                // é‡ç½®æ»¤é•œå’Œé€æ˜åº¦
                ctx.filter = 'none';
                ctx.globalAlpha = 1.0;
            }
            
            // PNGä¸‹è½½æŒ‰é’®äº‹ä»¶
            downloadPngBtn.addEventListener('click', function() {
                if (!currentImage1 && !currentImage2) {
                    alert('è¯·è‡³å°‘ä¸Šä¼ ä¸€å±‚å›¾ç‰‡ï¼');
                    return;
                }
                
                const canvas = generateIconCanvas();
                currentImageDataUrl = canvas.toDataURL('image/png');
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = 'generated-icon.png';
                link.href = currentImageDataUrl;
                link.click();
            });
            
            // ICOä¸‹è½½æŒ‰é’®äº‹ä»¶
            downloadIcoBtn.addEventListener('click', async function() {
                if (!currentImage1 && !currentImage2) {
                    alert('è¯·è‡³å°‘ä¸Šä¼ ä¸€å±‚å›¾ç‰‡ï¼');
                    return;
                }
                
                // å¦‚æœè¿˜æ²¡æœ‰ç”ŸæˆPNGæ•°æ®ï¼Œå…ˆç”Ÿæˆ
                if (!currentImageDataUrl) {
                    const canvas = generateIconCanvas();
                    currentImageDataUrl = canvas.toDataURL('image/png');
                }
                
                try {
                    downloadIcoBtn.disabled = true;
                    downloadIcoBtn.innerHTML = '<span>ç”Ÿæˆä¸­...</span>';
                    
                    await icoGenerator.downloadIco(currentImageDataUrl, 'generated-icon.ico');
                    
                    downloadIcoBtn.innerHTML = '<span>ä¸‹è½½ICOå›¾æ ‡</span>';
                } catch (error) {
                    console.error('ç”ŸæˆICOå¤±è´¥:', error);
                    alert('ç”ŸæˆICOæ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–ä½¿ç”¨PNGæ ¼å¼');
                    downloadIcoBtn.innerHTML = '<span>ä¸‹è½½ICOå›¾æ ‡</span>';
                } finally {
                    downloadIcoBtn.disabled = false;
                }
            });
            
            // åˆå§‹åŒ–
            updateSliderValues();
            applyAdjustments();
        });
    </script>
</body>
</html>